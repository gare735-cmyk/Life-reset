<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Life Reset Prototype</title>
  <style>
    :root{--gap:14px;--radius:14px}
    *{box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Apple SD Gothic Neo,Helvetica,Arial,"Noto Sans KR",sans-serif; margin:0; background:#0f1221; color:#f2f6ff}
    header{padding:20px; background:linear-gradient(120deg,#2a2f5a,#151936); position:sticky; top:0; z-index:2; border-bottom:1px solid #2b2f53}
    h1{font-size:20px; margin:0 0 8px 0; display:flex; align-items:center; gap:8px}
    h1 .logo{font-size:22px}
    .levelbar{display:flex; align-items:center; gap:10px}
    .bar{flex:1; height:10px; background:#1b2040; border-radius:99px; overflow:hidden; box-shadow:inset 0 0 0 1px #2b2f53}
    .fill{height:100%; background:linear-gradient(90deg,#5bd6ff,#60ffa4); width:0%}
    .meta{font-size:12px; opacity:.9}
    main{padding:18px}
    .card{background:#171a33; border:1px solid #282d54; border-radius:var(--radius); padding:14px; margin-bottom:var(--gap); box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    input,select,button,textarea{border-radius:10px; border:1px solid #2b2f53; background:#0f1433; color:#e7edff; padding:10px 12px; font-size:14px}
    button{background:#2b7fff; border:0; cursor:pointer}
    button.ghost{background:#171a33; border:1px solid #2b2f53}
    button:disabled{opacity:.5; cursor:not-allowed}
    .goal{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px; border-radius:12px; border:1px solid #2b2f53; background:#11152f; margin-bottom:10px}
    .goal .title{font-weight:600}
    .goal .tags{font-size:12px; opacity:.8}
    .goal.done{opacity:.65}
    .badges{display:flex; gap:8px; flex-wrap:wrap}
    .badge{padding:8px 10px; border-radius:999px; border:1px solid #2b2f53; background:#11152f; font-size:13px}
    .empty{opacity:.7; font-size:14px; text-align:center; padding:16px}
    .toast{position:fixed; left:50%; bottom:24px; transform:translateX(-50%); background:#0e5234; color:#d8ffef; padding:10px 14px; border-radius:999px; border:1px solid #237d59; display:none; z-index:5}
    .grid{display:grid; grid-template-columns:1fr; gap:var(--gap)}
    @media(min-width:850px){ .grid{grid-template-columns: 1.2fr 1fr} }
    .pill{font-size:11px; opacity:.85; border:1px solid #2b2f53; padding:4px 8px; border-radius:999px; background:#171a33}
    .danger{background:#721d32; border-color:#a63253}
    .success{background:#1b5533; border-color:#2a8a56}
    a{color:#86afff}
    .small{font-size:12px; opacity:.85}
  </style>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Life Reset">
<link rel="apple-touch-icon" href="icon.png">

</head>
<body>
<header>
  <h1><span class="logo">🎮</span> Life Reset <span class="pill" id="todayPill"></span></h1>
  <div class="levelbar">
    <div class="bar"><div id="xpFill" class="fill"></div></div>
    <div class="meta" id="xpMeta">Lv 1 · 0 / 100 XP</div>
  </div>
</header>

<main>
  <div class="grid">
    <section>
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:8px">
          <h2 style="margin:0;font-size:16px">오늘의 퀘스트</h2>
          <div class="small" id="summary"></div>
        </div>
        <div id="todayList"></div>
        <div class="empty" id="emptyToday" style="display:none">오늘 할 퀘스트가 없습니다. 새 목표를 추가하거나 내일 다시 도전해요!</div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 10px 0; font-size:16px">목표 추가</h2>
        <div class="row">
          <input id="goalTitle" placeholder="예: 30분 러닝 / 1과 사운딩" style="flex:2">
          <select id="goalType" style="flex:1">
            <option value="habit">습관(아무 때나)</option>
            <option value="daily">데일리(하루 1회)</option>
            <option value="oneoff">일회성</option>
          </select>
          <select id="goalDiff" style="flex:1">
            <option value="1">난이도 ★</option>
            <option value="2">난이도 ★★</option>
            <option value="3">난이도 ★★★</option>
          </select>
          <button onclick="addGoal()">추가</button>
        </div>
        <div class="small" style="margin-top:8px; opacity:.8">완료 시 획득 XP = 10 × 난이도. 일회성은 보너스 2배.</div>
        <div id="allList" style="margin-top:12px"></div>
      </div>
    </section>

    <aside>
      <div class="card">
        <h2 style="margin:0 0 10px 0; font-size:16px">배지</h2>
        <div class="badges" id="badges"></div>
        <div class="empty" id="emptyBadges" style="display:none">아직 배지가 없습니다. 연속 도전으로 배지를 획득하세요!</div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 10px 0; font-size:16px">데이터</h2>
        <div class="row">
          <button class="ghost" onclick="exportData()">백업(Export)</button>
          <button class="ghost" onclick="importData()">복원(Import)</button>
          <button class="ghost danger" onclick="resetAll()">하드 리셋</button>
        </div>
        <p class="small" style="margin-top:8px">데이터는 브라우저의 <b>로컬 저장소</b>에만 저장됩니다. 다른 기기에서는 동기화되지 않습니다.</p>
      </div>

      <div class="card">
        <h2 style="margin:0 0 10px 0; font-size:16px">사용 팁</h2>
        <ul class="small" style="margin:0 0 0 18px; line-height:1.6">
          <li>아이폰 Safari에서 이 파일을 열고 공유버튼 → 홈 화면에 추가로 앱처럼 사용.</li>
          <li>GitHub Pages에 업로드하면 어디서나 접속 가능.</li>
          <li>습관/데일리는 하루에 한 번만 XP가 지급됩니다.</li>
        </ul>
      </div>
    </aside>
  </div>
</main>

<div class="toast" id="toast"></div>

<script>
  // ---------- Utilities ----------
  const dayStr = (d=new Date()) => {
    const tzOffset = d.getTimezoneOffset() * 60000;
    const local = new Date(d - tzOffset);
    return local.toISOString().slice(0,10);
  };
  const yesterdayStr = () => {
    const d = new Date(); d.setDate(d.getDate()-1); return dayStr(d);
  };
  const uid = () => Math.random().toString(36).slice(2,9);

  const xpForLevel = (lvl) => 100 * (lvl*lvl);      // lvl 1->100, 2->400, 3->900...
  const levelFromXP = (xp) => Math.max(1, Math.floor(Math.sqrt(xp/100)) || 1);

  function toast(msg){
    const el = document.getElementById('toast');
    el.textContent = msg; el.style.display='block';
    setTimeout(()=> el.style.display='none', 1800);
  }

  // ---------- State ----------
  const defaultState = {
    createdAt: dayStr(),
    xp: 0,
    goals: [], // {id,title,type,difficulty,streak,lastDone,completed}
    badges: [] // {id,title,emoji,earnedAt}
  };
  let state = load();

  function save(){ localStorage.setItem('lifeReset', JSON.stringify(state)); }
  function load(){
    try{
      const s = JSON.parse(localStorage.getItem('lifeReset'));
      return s ? s : structuredClone(defaultState);
    }catch(e){ return structuredClone(defaultState); }
  }

  // ---------- Badge Logic ----------
  const hasBadge = (id) => state.badges.some(b=>b.id===id);
  function awardBadge(id,title,emoji){
    if (!hasBadge(id)){
      state.badges.push({id,title,emoji,earnedAt: dayStr()});
      toast(`배지 획득! ${emoji} ${title}`);
    }
  }
  function checkBadges(){
    const total = state.goals.length;
    if (total >= 3) awardBadge('starter','첫 목표 3개 설정','🎯');
    if (state.xp >= 100) awardBadge('xp100','100 XP 달성','💠');
    if (state.xp >= 500) awardBadge('xp500','500 XP 달성','🔷');
    if (state.xp >= 1000) awardBadge('xp1000','1000 XP 달성','💎');

    state.goals.forEach(g=>{
      if (g.streak >= 3) awardBadge('streak3','3일 연속','🔥');
      if (g.streak >= 7) awardBadge('streak7','7일 연속','⚡️');
      if (g.streak >= 30) awardBadge('streak30','30일 연속','🏆');
    });
  }

  // ---------- XP + Done ----------
  function completeGoal(id){
    const g = state.goals.find(x=>x.id===id);
    if (!g) return;
    const today = dayStr();
    const yest = yesterdayStr();
    const base = 10 * (g.difficulty||1);
    if (g.type === 'oneoff'){
      if (g.completed){ toast('이미 완료된 일회성 목표입니다.'); return; }
      state.xp += base * 2;
      g.completed = true;
      g.lastDone = today;
      g.streak = (g.streak||0) + 1;
      toast(`+${base*2} XP! 일회성 완료 🎉`);
    }else{
      if (g.lastDone === today){ toast('오늘은 이미 완료했어요.'); return; }
      state.xp += base;
      if (g.lastDone === yest) g.streak = (g.streak||0) + 1; else g.streak = 1;
      g.lastDone = today;
      toast(`+${base} XP! 잘했어요 ✅`);
    }
    save(); checkBadges(); render();
  }

  // ---------- CRUD Goals ----------
  function addGoal(){
    const title = document.getElementById('goalTitle').value.trim();
    const type = document.getElementById('goalType').value;
    const difficulty = parseInt(document.getElementById('goalDiff').value,10);
    if (!title){ toast('목표 제목을 입력하세요.'); return; }
    state.goals.push({id:uid(), title, type, difficulty, streak:0, lastDone:null, completed:false});
    document.getElementById('goalTitle').value='';
    save(); checkBadges(); render();
  }
  function removeGoal(id){
    if (confirm('정말 삭제할까요? 진행 데이터가 사라집니다.')){
      state.goals = state.goals.filter(g=>g.id!==id);
      save(); render();
    }
  }

  // ---------- Export / Import ----------
  function exportData(){
    const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `life-reset-backup-${Date.now()}.json`; a.click();
    URL.revokeObjectURL(url);
  }
  function importData(){
    const input = document.createElement('input');
    input.type = 'file'; input.accept = 'application/json';
    input.onchange = (e)=>{
      const file = e.target.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const s = JSON.parse(reader.result);
          if (!s || !('xp' in s) || !('goals' in s)) throw new Error('invalid');
          state = s; save(); render(); toast('복원 완료!');
        }catch(err){ alert('백업 파일 형식이 올바르지 않습니다.'); }
      };
      reader.readAsText(file);
    };
    input.click();
  }
  function resetAll(){
    if (confirm('모든 데이터를 초기화할까요? 이 작업은 되돌릴 수 없습니다.')){
      state = structuredClone(defaultState);
      save(); render(); toast('초기화 완료');
    }
  }

  // ---------- Render ----------
  function render(){
    // Header
    const lvl = levelFromXP(state.xp);
    const curBase = xpForLevel(lvl);
    const nextBase = xpForLevel(lvl+1);
    const curInLevel = state.xp - curBase;
    const need = nextBase - curBase;
    const pct = Math.max(0, Math.min(100, Math.round((curInLevel/need)*100)));
    document.getElementById('xpFill').style.width = pct + '%';
    document.getElementById('xpMeta').textContent = `Lv ${lvl} · ${Math.max(0,curInLevel)} / ${need} XP`;

    document.getElementById('todayPill').textContent = `오늘 · ${dayStr()}`;

    // Today list
    const today = dayStr();
    const todayGoals = state.goals.filter(g=>{
      if (g.type==='oneoff') return !g.completed; // show if not done
      return g.lastDone !== today; // show if not done yet today
    });
    const todayList = document.getElementById('todayList');
    todayList.innerHTML='';
    if (todayGoals.length===0){ document.getElementById('emptyToday').style.display='block'; }
    else { document.getElementById('emptyToday').style.display='none'; }
    todayGoals.forEach(g=> todayList.appendChild(goalItem(g,true)));

    // All list
    const allList = document.getElementById('allList'); allList.innerHTML='';
    state.goals.forEach(g=> allList.appendChild(goalItem(g,false)));

    // Summary
    const total = state.goals.length;
    const left = todayGoals.length;
    document.getElementById('summary').textContent = `총 ${total}개 · 남은 ${left}개`;

    // Badges
    const b = document.getElementById('badges'); b.innerHTML='';
    if (!state.badges.length) document.getElementById('emptyBadges').style.display='block';
    else document.getElementById('emptyBadges').style.display='none';
    state.badges.forEach(x=>{
      const el = document.createElement('div');
      el.className='badge';
      el.textContent = `${x.emoji} ${x.title}`;
      b.appendChild(el);
    });
  }

  function goalItem(g, showDoneBtn){
    const el = document.createElement('div');
    const isDoneToday = (g.lastDone === dayStr()) || (g.type==='oneoff' && g.completed);
    el.className = 'goal' + (isDoneToday ? ' done':'');
    const tags = `${(g.type==='habit'?'습관':g.type==='daily'?'데일리':'일회성')} · ★${g.difficulty} · 연속 ${g.streak||0}일`;
    el.innerHTML = `
      <div style="min-width:0; flex:1">
        <div class="title">${escapeHTML(g.title)}</div>
        <div class="tags">${tags}</div>
      </div>
      <div style="display:flex; gap:8px; align-items:center">
        ${showDoneBtn? `<button ${isDoneToday?'disabled':''} onclick="completeGoal('${g.id}')">${isDoneToday?'완료됨':'완료'}</button>`:''}
        <button class="ghost" onclick="removeGoal('${g.id}')">삭제</button>
      </div>
    `;
    return el;
  }

  function escapeHTML(str){
    return str.replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }

  // init
  checkBadges(); render();
</script>
</body>
</html>